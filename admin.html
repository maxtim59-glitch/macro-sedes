<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Panel Admin - Validaci√≥n de Puntos</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #1a1a1a; color: white; padding: 20px; margin: 0; }
        .container { max-width: 1000px; margin: auto; background: #2d2d2d; padding: 20px; border-radius: 12px; border-top: 5px solid #27ae60; box-shadow: 0 4px 15px rgba(0,0,0,0.5); }
        h1 { color: #27ae60; text-align: center; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; background: #252525; }
        th, td { padding: 15px; border-bottom: 1px solid #444; text-align: left; }
        th { background: #27ae60; color: white; text-transform: uppercase; font-size: 0.9em; }
        .btn { border: none; padding: 8px 15px; border-radius: 6px; cursor: pointer; font-weight: bold; color: white; margin: 2px; transition: 0.2s; }
        .btn-aprobar { background: #27ae60; }
        .btn-aprobar:hover { background: #219150; }
        .btn-rechazar { background: #e67e22; }
        .btn-eliminar { background: #c0392b; }
        .badge { padding: 5px 10px; border-radius: 20px; font-size: 0.8em; text-transform: uppercase; font-weight: bold; }
        .pendiente { background: #f1c40f; color: black; }
        .aprobado { background: #27ae60; }
        .rechazado { background: #e67e22; }
        img { border-radius: 4px; transition: 0.3s; cursor: zoom-in; object-fit: cover; }
        img:hover { transform: scale(4); position: relative; z-index: 100; border: 2px solid white; box-shadow: 0 0 20px rgba(0,0,0,0.8); }
        .login-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #1a1a1a; display: flex; align-items: center; justify-content: center; z-index: 1000; }
        .login-box { text-align: center; background: #2d2d2d; padding: 40px; border-radius: 15px; border: 1px solid #444; }
        .login-box input { padding: 12px; border-radius: 5px; border: 1px solid #444; background: #1a1a1a; color: white; margin-bottom: 16px; width: 240px; display: block; }
        .top-actions { display: flex; justify-content: flex-end; margin-bottom: 10px; }
        .btn-salir { background: #555; }
        .btn-salir:hover { background: #666; }
    </style>
</head>
<body>

<div id="login" class="login-overlay">
    <div class="login-box">
        <h2>Acceso Restringido</h2>
        <input type="email" id="admin-email" placeholder="Correo de Admin" autocomplete="username">
        <input type="password" id="admin-pass" placeholder="Contrase√±a" autocomplete="current-password">
        <button class="btn btn-aprobar" onclick="verificar()">Entrar al Panel</button>
    </div>
</div>

<div class="container">
    <div class="top-actions">
        <button class="btn btn-salir" onclick="cerrarSesion()">Cerrar sesion</button>
    </div>
    <h1>Validaci√≥n de Zonas de Calistenia</h1>
    <p style="text-align: center; color: #aaa;">Gestiona los reportes recibidos desde el mapa.</p>
    <table>
        <thead>
            <tr>
                <th>Foto</th>
                <th>Detalles del Punto</th>
                <th>Estado</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody id="tabla-puntos"></tbody>
    </table>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
    // Configuraci√≥n de Supabase
    const SUPABASE_URL = 'https://afzevcxtdhoktzsjckie.supabase.co';
    const SUPABASE_KEY = 'sb_publishable_T7vPHcunOH0prZbYeiJoew_n_viACXt';
    const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    async function verificar() {
        const email = document.getElementById('admin-email').value.trim();
        const password = document.getElementById('admin-pass').value;
        if (!email || !password) {
            alert('Completa correo y contrase√±a');
            return;
        }

        const { error } = await _supabase.auth.signInWithPassword({ email, password });
        if (error) {
            alert('Login fallido: ' + error.message);
            return;
        }

        document.getElementById('login').style.display = 'none';
        cargarReporte();
    }

    async function cerrarSesion() {
        await _supabase.auth.signOut();
        document.getElementById('login').style.display = 'flex';
    }

    async function verificarSesion() {
        const { data } = await _supabase.auth.getSession();
        if (data && data.session) {
            document.getElementById('login').style.display = 'none';
            cargarReporte();
        } else {
            document.getElementById('login').style.display = 'flex';
        }
    }

    verificarSesion();

    // Helper para cargar datos de Supabase
    function getPuntosLocal() {
        return JSON.parse(localStorage.getItem('macro_puntos') || '[]');
    }
    function setPuntosLocal(arr) {
        localStorage.setItem('macro_puntos', JSON.stringify(arr));
    }

    async function cargarReporte() {
        try {
            const { data, error } = await _supabase.from('macro_puntos').select('*').order('id', { ascending: false });
            
            if (error) {
                alert('Error cargando puntos: ' + error.message);
                return;
            }

            const tbody = document.getElementById('tabla-puntos');
            tbody.innerHTML = "";

            if (data && data.length) {
                data.forEach(p => {
                    const foto = p.foto_url ? `<img src="${p.foto_url}" width="60" height="60" title="Pasa el mouse para ampliar">` : '<i>Sin foto</i>';
                    const titulo = p.descripcion || p.nombre_patrocinador || "Zona sin descripci√≥n";
                    const sublinea = `<br><small style="color:#bbb;">Subido por: <b>${p.nombre_persona || 'An√≥nimo'}</b> | Tipo: ${p.tipo_anuncio || 'N/A'}</small>`;
                    const motivoRechazo = p.mensaje_adm ? `<br><small style="color:#ff9f43;">Nota Admin: ${p.mensaje_adm}</small>` : '';
                    tbody.innerHTML += `
                    <tr>
                        <td>${foto}</td>
                        <td>
                            <span style="color:#27ae60; font-weight:bold; font-size:1.1em;">${titulo}</span>
                            ${sublinea}
                            ${motivoRechazo}
                        </td>
                        <td><span class="badge ${p.estado}">${p.estado}</span></td>
                        <td>
                            ${p.estado === 'pendiente' ? `<button class="btn btn-aprobar" onclick="actualizar(${p.id}, 'aprobado')">Aprobar ‚úÖ</button>` : ''}
                            <button class="btn btn-rechazar" onclick="rechazar(${p.id})">Rechazar ‚úñ</button>
                            <button class="btn btn-eliminar" onclick="eliminar(${p.id})">Eliminar üóë</button>
                        </td>
                    </tr>
                `;
                });
            } else {
                tbody.innerHTML = `<tr><td colspan="4" style="text-align:center;color:#aaa;">No hay reportes pendientes.</td></tr>`;
            }
        } catch (err) {
            alert('Error: ' + err.message);
        }
    }

    async function actualizar(id, nuevoEstado) {
        try {
            const { error } = await _supabase.from('macro_puntos').update({ estado: nuevoEstado }).eq('id', id);
            
            if (error) {
                alert('Error actualizando: ' + error.message);
                return;
            }
            
            alert('‚úÖ Punto ' + nuevoEstado);
            cargarReporte();
        } catch (err) {
            alert('Error: ' + err.message);
        }
    }

    async function rechazar(id) {
        const motivo = prompt("Motivo del rechazo:");
        if (!motivo) return;
        
        try {
            const { error } = await _supabase.from('macro_puntos').update({ 
                estado: 'rechazado',
                mensaje_adm: motivo 
            }).eq('id', id);
            
            if (error) {
                alert('Error rechazando: ' + error.message);
                return;
            }
            
            alert('‚ùå Punto rechazado');
            cargarReporte();
        } catch (err) {
            alert('Error: ' + err.message);
        }
    }

    async function eliminar(id) {
        if (!confirm("¬øEst√°s seguro de eliminar permanentemente este registro?")) return;
        
        try {
            const { error } = await _supabase.from('macro_puntos').delete().eq('id', id);
            
            if (error) {
                alert('Error eliminando: ' + error.message);
                return;
            }
            
            alert('üóë Registro eliminado');
            cargarReporte();
        } catch (err) {
            alert('Error: ' + err.message);
        }
    }
</script>
</body>
</html>
